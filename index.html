<!-- template.html -->
<html>
<head>
    <title>Personality Quiz</title>
    <script src="http://fb.me/react-with-addons-0.12.0.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <script src="modernizr.custom.96871.js"></script>
    <link rel="stylesheet" type="text/css" media="all" href="https://embed-13854.secondstreetapp.com/StaticContent/CSS/consumer_quiz.css">
    <style>
        html {
            background-color: #e5e5e5;
        }
        #ssFrontApp.ssPersonalityQuiz .ssQuestion .ssQuestionHeader .ssVerticalCenterTable {
            height: auto;
        }
        #ssFrontApp.ssPersonalityQuiz .ssButton.ssCalculateResultsButton {
            margin: 0 auto;
            display: block;
        }
        #ssFrontApp.ssPersonalityQuiz .ssQuiz {
            border-bottom: 0;
        }
        #ssFrontApp .ssSubmissionError {
            text-align: center;
        }
    </style>
</head>
<body>
<div id="ssFrontApp" class="ssPersonalityQuiz"></div>
<script type="text/jsx">
    var quizSubmission;
    var headers = {
        'X-Organization-Promotion-Id': 13854,
        'X-Referring-Url': 'https://embed-13854.secondstreetapp.com/embed/d4b26171-8fd2-4439-b574-96ab9ca5cae3/',
        'Content-Type': 'application/json; charset=UTF-8',
        'Accept': 'application/json, text/javascript, */*; q=0.01',
        'X-Organization-Id': 5403,
        'X-Promotion-Id': 13854,
        'X-Api-Key': 65032887
    };
    var Quiz = React.createClass({
        getInitialState: function() {
            return {questionData: [], outcomeData: null, submitError: null};
        },
        submitQuiz: function(qs){
            $.ajax({
                type: 'POST',
                url: 'https://embed-13854.secondstreetapp.com/api/quiz_submissions',
                dataType: 'json',
                data: qs,
                headers: headers,
                success: function(data) {
                    console.log(data);
                    this.setState({outcomeData: data.quiz_submissions[0].outcome_id})
                }.bind(this),
                error: function(xhr, status, err) {
                    console.error(this.props.url, status, err.toString());
                }.bind(this)
            });
        },
        componentDidMount: function() {
            $.ajax({
                url: this.props.url,
                dataType: 'json',
                success: function(data) {
                    this.setState({questionData: data});
                    //Set up the quiz submission with initial data
                    quizSubmission = {
                        "quiz_submissions": [
                            {
                                "question_option_picks":[]
                            }
                        ]
                    };
                    data.questions.forEach(function(question){
                        quizSubmission.quiz_submissions[0].question_option_picks.push({
                            question_id: question.id,
                            question_option_id: null,
                            quiz_submission_id: null
                        })
                    });
                }.bind(this),
                error: function(xhr, status, err) {
                    console.error(this.props.url, status, err.toString());
                }.bind(this)
            });
        },
        render: function(){
            var calculateResults = function(){
                var isQuizComplete = !quizSubmission.quiz_submissions[0].question_option_picks.filter(function(pick){
                    return !pick.question_option_id;
                }).length;
                if(isQuizComplete){
                    this.submitQuiz(JSON.stringify(quizSubmission));
                }
                else {
                    this.setState({submitError: 'You have not answered all questions'});
                }

            }.bind(this);
            var errors = this.state.submitError ? <p className="ssSubmissionError">{this.state.submitError}</p> : null;

            var renderContents;
            if(this.state.outcomeData){
                renderContents = (
                    <div className="ssOutcome">
                        You Got Outcome #{this.state.outcomeData}
                    </div>
                );
            }
            else {
                renderContents = (
                    <div className="ssAppContentArea ssLayoutMedium ssLayoutLarge ssLayoutDetermined">
                        <div className="ssQuiz">
                            <QuestionList data={this.state.questionData.questions}/>
                            {errors}
                            <SubmitButton submit={calculateResults}/>
                        </div>
                    </div>
                );
            }
            return renderContents;
        }
    });

    var SubmitButton = React.createClass({
        render: function(){
            return (
                <button className="ssCalculateResultsButton ssButtonPrimary ssButton" onClick={this.props.submit}>Submit</button>
            )
        }
    });

    var QuestionList = React.createClass({

        render: function(){
            if(this.props.data){ //Handle if the data hasn't loaded yet
                var questionNodes = this.props.data.map(function (question) {
                    return (
                        <Question id={question.id} name={question.name} displayOrder={question.display_order} questionOptions={question.question_options}>
                        </Question>
                    );
                });
            }

            return (
                <div className="ssQuestions ssMainContent">
                    {questionNodes}
                </div>
            )
        }
    });
    var Question = React.createClass({
        render: function(){
            return (
                <div className="ssQuestion">
                    <div className="ssQuestionHeader">
                        <div className="ssVerticalCenterTable">
                            <h2 className="ssVerticalCenterTableRow ssQuestionTitle">
                                <span className="ssVerticalCenterTableData ssQuestionNumber">#{this.props.displayOrder}</span>
                                <span className="ssVerticalCenterTableData ssQuestionName">{this.props.name}</span>

                            </h2>
                        </div>
                    </div>
                    <QuestionOptionsList data={this.props.questionOptions} questionId={this.props.id} />
                </div>
            )
        }
    });
    var QuestionOptionsList = React.createClass({
        getInitialState: function() {
            return {picked: null};
        },
        render: function(){
            var setPicked = function(qo){
                this.setState({picked: qo});
                var submissionPicks = quizSubmission.quiz_submissions[0].question_option_picks;
                var pickToChange = submissionPicks.filter(function(pick){
                    return pick.question_id === this.props.questionId;
                }.bind(this))[0];
                pickToChange.question_option_id = qo.props.id;

            }.bind(this);
            var questionOptionNodes = this.props.data.map(function (questionOption) {
                if(this.state.picked && this.state.picked.props.id === questionOption.id){
                    return (
                        <QuestionOption id={questionOption.id} name={questionOption.name} displayOrder={questionOption.display_order} setPicked={setPicked} picked="true">
                        </QuestionOption>
                    )
                }
                return (
                        <QuestionOption id={questionOption.id} name={questionOption.name} displayOrder={questionOption.display_order} setPicked={setPicked}>
                        </QuestionOption>
                );
            }.bind(this));
            return (
                <div className="ssQuestionOptions">
                    <ul className="ssThumbnailGrid">
                        {questionOptionNodes}
                    </ul>
                </div>
            )
        }
    });
    var QuestionOption = React.createClass({
        render: function(){
            var cx = React.addons.classSet;
            var classes = cx({
                'ssThumbnailGridSquare': true,
                'picked': this.props.picked
            });
            return (
                <li className="ssThumbnailGridItem ssClickable ssThumbnailGridItemTextOnly" onClick={function(){this.props.setPicked(this)}.bind(this)}>
                    <a className={classes}>
                        <div className="ssVerticalCenterTableContainer">
                            <div className="ssVerticalCenterTable">
                                <div className="ssVerticalCenterTableRow">
                                    <div className="ssVerticalCenterTableData">
                                        {this.props.name}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                </li>
            )
        }
    });
    React.render(
        <Quiz url="questions.json" />,
        document.getElementById('ssFrontApp')
    );
</script>
</body>
</html>